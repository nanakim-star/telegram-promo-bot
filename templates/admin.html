<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>í…”ë ˆê·¸ë¨ ë´‡ ê´€ë¦¬ì í˜ì´ì§€</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            margin: 2em; 
            background-color: #f4f4f9; 
            color: #333; 
        }
        .container { 
            max-width: 960px; 
            margin: auto; 
            padding: 2em; 
            background: white; 
            border-radius: 8px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
        }
        h1, h2, h3 { 
            border-bottom: 2px solid #eee; 
            padding-bottom: 10px; 
            color: #1a1a1a; 
        }
        h3 { margin-top: 1.5em; }
        hr { border: 0; border-top: 1px solid #eee; margin: 2em 0; }
        form { margin-bottom: 1.5em; }
        label { font-weight: 500; display: block; margin-bottom: 5px; }
        textarea, input[type="text"], input[type="number"], input[type="file"] { 
            width: 98%; 
            max-width: 98%;
            padding: 10px; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
            font-size: 1em; 
            margin-bottom: 1em;
        }
        textarea { height: 120px; resize: vertical; }
        button, .button-link { 
            padding: 10px 15px; 
            border: none; 
            border-radius: 4px; 
            font-size: 1em; 
            cursor: pointer; 
            font-weight: 500; 
            text-decoration: none;
            color: white;
            display: inline-block;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .btn-primary { background-color: #007bff; }
        .btn-primary:hover { background-color: #0056b3; }
        .btn-secondary { background-color: #6c757d; }
        .btn-secondary:hover { background-color: #5a6268; }
        .btn-danger { background-color: #dc3545; }
        .btn-danger:hover { background-color: #c82333; }
        .btn-success { background-color: #28a745; }
        .btn-success:hover { background-color: #218838; }
        .btn-info { background-color: #17a2b8; }
        .btn-info:hover { background-color: #138496; }

        .info, .message { background-color: #e7f3fe; border-left: 6px solid #2196F3; padding: 1em; margin-top: 1em; }
        .photo-info, .spintax-info { font-size: 0.9em; color: #555; margin-bottom: 5px; }
        
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1em; margin-bottom: 2em; }
        .dash-card { background: #f8f9fa; padding: 1.5em; border-radius: 5px; text-align: center; border: 1px solid #eee; }
        .dash-card h4 { margin: 0 0 10px 0; color: #555; font-weight: 500; }
        .dash-card p { font-size: 2em; font-weight: bold; margin: 0; color: #007bff; }
        
        .activity-log ul { list-style: none; padding: 0; max-height: 200px; overflow-y: auto; border: 1px solid #eee; border-radius: 4px;}
        .activity-log li { background: #f8f9fa; padding: 10px; border-bottom: 1px solid #eee; font-size: 0.9em; }
        .activity-log li:last-child { border-bottom: none; }

        .scheduler-status { margin-bottom: 1em; }
        .paused { color: #dc3545; font-weight: bold; }
        .running { color: #28a745; font-weight: bold; }

        table { width: 100%; border-collapse: collapse; margin-top: 1.5em; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #f8f9fa; }
    </style>
</head>
<body>
    <div class="container">
        <h2>ğŸ“Š ëŒ€ì‹œë³´ë“œ & ë´‡ ì œì–´</h2>
        <div class="scheduler-status">
            <strong>ìŠ¤ì¼€ì¤„ëŸ¬ ìƒíƒœ:</strong> 
            {% if scheduler_state == 1 %}
                <span class="running">ì‹¤í–‰ ì¤‘</span>
                <button class="btn-danger" onclick="toggleScheduler('pause')">ê¸´ê¸‰ ì¤‘ë‹¨</button>
            {% else %}
                <span class="paused">ì¼ì‹œì •ì§€ë¨</span>
                <button class="btn-success" onclick="toggleScheduler('resume')">ë‹¤ì‹œ ì‹œì‘</button>
            {% endif %}
        </div>
        <div class="dashboard">
            <div class="dash-card">
                <h4>ì˜¤ëŠ˜ ë°œì†¡ëœ ë©”ì‹œì§€</h4>
                <p>{{ dashboard.sent_today }}</p>
            </div>
            <div class="dash-card">
                <h4>ë“±ë¡ëœ í™ë³´ë°©</h4>
                <p>{{ dashboard.room_count }}</p>
            </div>
        </div>
        <div class="activity-log">
            <h3>ìµœê·¼ í™œë™ ë¡œê·¸</h3>
            <ul>
                {% for log in dashboard.recent_logs %}
                    <li>{{ log.timestamp }} - {{ log.details }}</li>
                {% else %}
                    <li>ì•„ì§ í™œë™ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</li>
                {% endfor %}
            </ul>
        </div>

        <hr>

        <h2>âš™ï¸ ê¸°ë³¸ ì„¤ì •</h2>
        <form id="config-form" method="post" enctype="multipart/form-data">
            <h3>1. í™ë³´ ë¬¸êµ¬</h3>
            <p class="spintax-info">ìŠ¤í•€íƒìŠ¤ ì‚¬ìš© ê°€ëŠ¥: {ë‹¨ì–´1|ë‹¨ì–´2} í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•˜ë©´ ë°œì†¡ ì‹œë§ˆë‹¤ ëœë¤í•˜ê²Œ ì„ íƒë©ë‹ˆë‹¤.</p>
            <textarea name="message" placeholder="í™ë³´í•  ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”.">{{ config.message }}</textarea>

            <h3>2. í™ë³´ìš© ì‚¬ì§„</h3>
            <input type="file" name="photo">
            {% if config.photo %}
            <p class="photo-info">í˜„ì¬ ë“±ë¡ëœ ì‚¬ì§„: <strong>{{ config.photo }}</strong></p>
            {% endif %}
            
            <h3>3. ëœë¤ ë°œì†¡ ê°„ê²© (ë¶„)</h3>
            <div style="display: flex; gap: 1em;">
                <div style="flex: 1;">
                    <label for="interval_min">ìµœì†Œ ê°„ê²©</label>
                    <input type="number" id="interval_min" name="interval_min" value="{{ config.interval_min }}">
                </div>
                <div style="flex: 1;">
                    <label for="interval_max">ìµœëŒ€ ê°„ê²©</label>
                    <input type="number" id="interval_max" name="interval_max" value="{{ config.interval_max }}">
                </div>
            </div>
            
            <h3>4. ë¯¸ë¦¬ë³´ê¸° í…ŒìŠ¤íŠ¸</h3>
            <label for="preview_id">í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ë¥¼ ë°›ì„ ë³¸ì¸ì˜ ìˆ«ì ID</label>
            <input type="text" id="preview_id" name="preview_id" value="{{ config.preview_id }}">
            <button type="button" class="btn-secondary" onclick="sendPreview(this)">ë¯¸ë¦¬ë³´ê¸° ë°œì†¡</button>

            <button type="submit" class="btn-primary" style="width: 100%; margin-top: 2em;">ê¸°ë³¸ ì„¤ì • ì €ì¥í•˜ê¸°</button>
        </form>

        {% if message %}
        <div class="message">
            <p><strong>{{ message }}</strong></p>
        </div>
        {% endif %}

        <hr>

        <h2>ğŸ—‚ï¸ í™ë³´ë°© ê´€ë¦¬</h2>
        <form id="add-room-form">
            <h3>ì‹ ê·œ ë°© ì¶”ê°€</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1em;">
                <input type="text" name="chat_id" placeholder="ì±„íŒ…ë°© ID (í•„ìˆ˜)" required>
                <input type="text" name="room_name" placeholder="ì±„íŒ…ë°© ì´ë¦„ (ë³„ì¹­)">
                <input type="text" name="room_group" placeholder="ê·¸ë£¹ëª…" value="ê¸°ë³¸">
            </div>
            <button type="submit" class="btn-success">ìƒˆë¡œìš´ ë°© ì¶”ê°€</button>
        </form>

        <h3>ì¼ê´„ ê´€ë¦¬</h3>
        <form action="/import_rooms" method="post" enctype="multipart/form-data" style="display:inline-block;">
            <input type="file" name="file" required>
            <button type="submit" class="btn-info">CSV ê°€ì ¸ì˜¤ê¸°</button>
        </form>
        <a href="/export_rooms" class="button-link btn-secondary">CSV ë‚´ë³´ë‚´ê¸°</a>
        <button class="btn-info" onclick="checkRooms(this)">ëª¨ë“  ë°© ìƒíƒœ í™•ì¸</button>


        <h3>ë“±ë¡ëœ ë°© ëª©ë¡</h3>
        <table>
            <thead>
                <tr>
                    <th>Chat ID</th>
                    <th>ì´ë¦„</th>
                    <th>ê·¸ë£¹</th>
                    <th>ë§ˆì§€ë§‰ ìƒíƒœ</th>
                    <th>ê´€ë¦¬</th>
                </tr>
            </thead>
            <tbody>
                {% for room in promo_rooms %}
                <tr>
                    <td>{{ room.chat_id }}</td>
                    <td>{{ room.room_name }}</td>
                    <td>{{ room.room_group }}</td>
                    <td>{{ room.last_status }}</td>
                    <td>
                        <button class="btn-danger" onclick="deleteRoom({{ room.id }})">ì‚­ì œ</button>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="5" style="text-align: center;">ë“±ë¡ëœ ë°©ì´ ì—†ìŠµë‹ˆë‹¤.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <script>
        function showLoading(button, text = 'ì²˜ë¦¬ ì¤‘...') {
            button.dataset.originalText = button.textContent;
            button.textContent = text;
            button.disabled = true;
        }

        function hideLoading(button) {
            button.textContent = button.dataset.originalText;
            button.disabled = false;
        }

        // ìŠ¤ì¼€ì¤„ëŸ¬ ì œì–´
        function toggleScheduler(action) {
            const button = event.target;
            showLoading(button);
            fetch(`/toggle_scheduler/${action}`, { method: 'POST' })
                .finally(() => window.location.reload());
        }

        // ë¯¸ë¦¬ë³´ê¸° ë°œì†¡
        function sendPreview(button) {
            const form = document.getElementById('config-form');
            const formData = new FormData(form);
            showLoading(button);
            fetch('/preview', { method: 'POST', body: formData })
                .then(response => response.json())
                .then(data => alert(data.message))
                .catch(error => alert('ë¯¸ë¦¬ë³´ê¸° ì „ì†¡ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + error))
                .finally(() => hideLoading(button));
        }

        // ë°© ì¶”ê°€
        document.getElementById('add-room-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const button = this.querySelector('button');
            showLoading(button);
            fetch('/add_room', { method: 'POST', body: new FormData(this) })
                .finally(() => window.location.reload());
        });

        // ë°© ì‚­ì œ
        function deleteRoom(roomId) {
            if (confirm('ì •ë§ë¡œ ì´ ë°©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                const button = event.target;
                showLoading(button);
                fetch(`/delete_room/${roomId}`, { method: 'POST' })
                    .finally(() => window.location.reload());
            }
        }

        // ë°© ìƒíƒœ í™•ì¸
        function checkRooms(button) {
            showLoading(button, 'ìƒíƒœ í™•ì¸ ì¤‘...');
            fetch('/check_rooms', { method: 'POST' })
                .then(response => response.text())
                .then(message => {
                    alert(message);
                    window.location.reload();
                })
                .catch(error => alert('ìƒíƒœ í™•ì¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + error))
                .finally(() => hideLoading(button));
        }
    </script>
</body>
</html>